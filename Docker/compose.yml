version: "3.9"

x-airflow-common: &airflow-common
  build:
    context: .
    dockerfile: Dockerfile
  environment: &airflow-environment
    AIRFLOW__CORE__EXECUTOR: SequentialExecutor
    AIRFLOW__DATABASE__SQL_ALCHEMY_CONN: sqlite:////opt/airflow/airflow.db
    AIRFLOW__CORE__LOAD_EXAMPLES: "false"
    AIRFLOW__API__AUTH_BACKENDS: airflow.api.auth.backend.basic_auth
    # IMPORTANT: Update the user and password to match ClickHouse admin
    AIRFLOW_CONN_CLICKHOUSE_DEFAULT: "clickhouse://airflow:password@clickhouse:9000/sp600_stocks"
  volumes:
    - ./dags:/opt/airflow/dags
    - ./logs:/opt/airflow/logs
    - ./data:/opt/airflow/data
    - ./dbt:/opt/airflow/dbt
    - airflow_internal:/opt/airflow

services:
  clickhouse:
    image: clickhouse/clickhouse-server:23.8
    container_name: clickhouse
    restart: unless-stopped
    ports:
      - "8123:8123"
      - "9000:9000"
    volumes:
      - clickhouse_data:/var/lib/clickhouse
      - ./clickhouse_init:/docker-entrypoint-initdb.d
      - ./data:/var/lib/clickhouse/user_files
    environment:
      CLICKHOUSE_DB: sp600_stocks
      CLICKHOUSE_DEFAULT_ACCESS_MANAGEMENT: 1
      # Create 'airflow' as the primary admin user
      CLICKHOUSE_USER: airflow
      # Set the password for the 'airflow' user (and the 'default' user)
      CLICKHOUSE_PASSWORD: password
    healthcheck:
      # Healthcheck now uses the 'airflow' user to authenticate
      test: ["CMD", "curl", "-f", "http://localhost:8123/ping"]
      interval: 2s
      timeout: 1s
      retries: 5
      start_period: 2s

  airflow-webserver:
    <<: *airflow-common
    container_name: airflow-webserver
    restart: unless-stopped
    command: >
      bash -c "airflow db migrate &&
      airflow users create --username airflow --password airflow --firstname Admin --lastname User --role Admin --email admin@example.com || true &&
      airflow webserver"
    ports:
      - "8080:8080"
#    depends_on:
#      clickhouse:
#        condition: service_healthy

  airflow-scheduler:
    <<: *airflow-common
    container_name: airflow-scheduler
    restart: unless-stopped
    command: airflow scheduler
    depends_on:
      - airflow-webserver

volumes:
  clickhouse_data:
  airflow_internal: