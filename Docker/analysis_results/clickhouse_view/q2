docker compose exec -T clickhouse bash -lc '
cat <<SQL | clickhouse-client --multiquery
WITH
  [''sp500'',''sp600''] AS wanted_indexes,
  this_year AS (SELECT toYear(today()) AS y),
  latest_membership AS (
    SELECT index_name, max(snapshot_date) AS snap
    FROM analytics.index_membership_snapshots
    WHERE index_name IN wanted_indexes
    GROUP BY index_name
  ),
  universe AS (
    SELECT DISTINCT m.Symbol
    FROM analytics.index_membership_snapshots m
    ANY INNER JOIN latest_membership l
      ON m.index_name = l.index_name AND m.snapshot_date = l.snap
  ),
  comp_by_year AS (
    SELECT Symbol, toYear(snapshot_date) AS year, anyLast(Sector) AS Sector
    FROM (
      SELECT Symbol, Sector, snapshot_date,
             row_number() OVER (PARTITION BY Symbol, toYear(snapshot_date) ORDER BY snapshot_date DESC) AS rn
      FROM analytics.company_overview_snapshots
    )
    WHERE rn = 1
    GROUP BY Symbol, year
  )
SELECT
  c.Sector,
  toYear(d.Date) AS year,
  avg( (d.Open + d.Close) / 2 ) AS avg_price
FROM analytics.daily_stock_prices d
ANY INNER JOIN universe u ON u.Symbol = d.Ticker
ANY LEFT JOIN comp_by_year c ON c.Symbol = d.Ticker AND c.year = toYear(d.Date)
WHERE toYear(d.Date) BETWEEN (SELECT y - 9 FROM this_year) AND (SELECT y FROM this_year)
GROUP BY c.Sector, year
ORDER BY c.Sector, year
FORMAT Pretty;
SQL
'

The answer to this can be found in avg_price_by_sector_10y.csv
